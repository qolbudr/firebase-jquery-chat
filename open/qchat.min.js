class QChat {
  static startChat({myId, toId, myName, toName, message}) {
    let docMyId = myId.toString();
    let docToId = toId.toString();

    db.collection('user').doc(docMyId).set({
      id: myId,
      name: myName,
      created: + new Date()
    },
    {
      merge: true
    }); 

    db.collection('user').doc(docToId).set({
      id: toId,
      name: toName,
      created: + new Date()
    },
    {
      merge: true
    }); 

    db.collection('group').add({
      created: + new Date(),
      createdBy: myId,
      members: [myId, toId],
      recentMessage: {
        text: message,
        read: false,
        sent: + new Date(),
        sender: myId
      }
    },
    {
      merge: true
    }).then(function(docRef) {
      db.collection(`message/${docRef.id}/messages`).doc().set(
        {
          sent: + new Date(),
          sender: myId,
          message: message,
          read: false
        }
      )
    })
  }

  static getMemberData(myId, arrayofMember, groupId) {
    let toId = this
    arrayofMember.forEach(function(member) {
      if(member != myId) {
        toId = member;
      }
    })

    let docToId = toId.toString();
    db.collection('user').doc(docToId).get().then(function(data) {
      let d = data.data();
      $(`.content[groupId=${groupId}] h4`).text(d.name)
    })
  }

  static getUnreadCount(myId, groupId) {
    db.collection(`message/${groupId}/messages`).where('read', '==', false).onSnapshot(function(data) {
      let array = [];

      data.forEach(function(value) {
        const d = value.data();
        if(d.sender != myId) {
          d.id = value.id
          array.push(d);
        }
      })

      if(array.length > 0) {
        $(`.content[groupId=${groupId}] .unread`).show()
        $(`.content[groupId=${groupId}] .unread`).text(array.length)
      } else {
        $(`.content[groupId=${groupId}] .unread`).hide()
      }
    })
  }

  static getChat(myId, groupId, elem, color) {
    db.collection(`message/${groupId}/messages`).orderBy('sent', 'asc').onSnapshot(function(value) {
      $(`${elem} .chat-content-list`).html('');
      value.forEach(function(data) {
        let chat = data.data();
        if(chat.sender != myId) {
          let date = new Date(chat.sent)
          let time = `${date.getHours()}:${('0'+date.getMinutes()).slice(-2)}`
          $(`${elem} .chat-content-list`).append(
            `
              <div class="chat-reply">
                <div class="text">
                  <div class="text-data">${chat.message}</div>
                  <div class="text-time">${time}</div>
                </div>
              </div>
            `
          )
        } else {
          let date = new Date(chat.sent)
          let time = `${date.getHours()}:${('0'+date.getMinutes()).slice(-2)}`
          $(`${elem} .chat-content-list`).append(
            `
              <div class="chat-send">
                <div class="text" style="background-color: ${color}">
                  <div class="text-data">${chat.message}</div>
                  <div class="text-time">${time}</div>
                </div>
              </div>
            `
          )
        }
      })

      let height = $(`${elem} .chat-content-list`).height();
      $(`${elem} .chat-content-list`).slimScroll({scrollTo: 10000});
    })
  }

  static markAsRead(myId, groupId) {
    let groupRef = db.doc(`group/${groupId}`)
    let messageRef = db.collection(`message/${groupId}/messages`)
    groupRef.get().then(function(value) {
      let data = value.data();
      if(data.recentMessage.sender != myId) {
        groupRef.set({
          recentMessage: {
            read: true
          }
        }, 
        {
          merge: true
        })
      }
    })

    messageRef.where('read', '==', false).get().then(function(value) {
      value.forEach(function(data) {
        let d = data.data();

        if(d.sender != myId) {
          messageRef.doc(data.id).set({
            read: true
          }, 
          {
            merge: true
          })
        }
      })
    })
  }

  static sendChat(myId, groupId, message) {
    const recentMessage = {
      read: false,
      sent: + new Date(),
      text: message,
      sender: myId
    }

    const messages = {
      read: false,
      sent: + new Date(),
      message: message,
      sender: myId
    }

    db.doc(`group/${groupId}`).set({
      recentMessage: recentMessage
    }, 
    {
      merge: true
    })

    db.collection(`message/${groupId}/messages`).add(messages);
  }

  static getListChat(settings, elem) {
    const vm = this
    return new Promise((resolve, reject) => {
      const groupRef = db.collection('group')
      groupRef.where('members', 'array-contains', settings.myId).onSnapshot((querySnapshot) => {
         const allGroups = []
         querySnapshot.forEach((doc) => {
           const data = doc.data()
           data.id = doc.id
           if (data.recentMessage) allGroups.push(data)
         })
         vm.groups = allGroups
         $(`${elem} .chat-list-person`).html('');
         allGroups.forEach(function(list) {
          let date = new Date(list.recentMessage.sent);
          let time = `${date.getHours()}:${('0'+date.getMinutes()).slice(-2)}`

          $(`${elem} .chat-list-person`).append(`
            <div class="content" groupId="${list.id}">
              <div class="list-data">
                <div class="dp-picture">
                  <img src="https://www.sunsetlearning.com/wp-content/uploads/2019/09/User-Icon-Grey-300x300.png">
                </div>
                <div class="dp-message">
                  <h4>Qolbu</h4>
                  <div class="dp-status">
                    <div class="status-icon">
                      <div class="sent">
                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#bdbdbd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>
                      </div>
                      <div class="read">
                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="${settings.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <svg style="margin-left: -13px;" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="${settings.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>
                      </div>
                    </div>
                    <div class="truncate">
                      <h5>${list.recentMessage.text}</h5>
                    </div>
                  </div>
                </div>
              </div>
              <div class="msg-status">
                <h6>${time}</h6>
                <div class="unread" style="background-color: ${settings.color}">1</div>
              </div>
            </div>
          `)

          if(list.recentMessage.sender != settings.myId) {
            $(`${elem} .content[groupId=${list.id}] .status-icon`).hide()
          } else {
            $(`${elem} .content[groupId=${list.id}] .status-icon`).show()
            if(list.recentMessage.read == true) {
              $(`${elem} .content[groupId=${list.id}] .read`).css('display', 'flex')
              $(`${elem} .content[groupId=${list.id}] .sent`).hide()
            } else {
              $(`${elem} .content[groupId=${list.id}] .sent`).show()
              $(`${elem} .content[groupId=${list.id}] .read`).hide()
            }
          }

          QChat.getMemberData(settings.myId, list.members, list.id);
          QChat.getUnreadCount(settings.myId, list.id);

          $(`${elem} .chat-list-person .content`).click(function() {
            let height = $(`${elem} .chat-box`).height() - 117
            let name = $(this).find('h4:first').text();
            let groupId = $(this).attr('groupId');

            $(`${elem} .chat-list-person`).slimScroll({height: '0'});
            $(`${elem} .chat-content-list`).slimScroll({height: height});
            $(`${elem} .chat-content-list`).css({height: height - 29});
            $(`${elem} .chat-content`).show();
            $(`${elem} .chat-back`).show();
            $(`${elem} #chat-input`).attr('groupId', groupId)
            $(`${elem} #btn-send`).attr('groupId', groupId)
            $(`${elem} .chat-title`).text(name)

            QChat.getChat(settings.myId, groupId, elem, settings.color);
            QChat.markAsRead(settings.myId, groupId);
          })

         })
       })
    })
  }
}

(function ($) {
    $.fn.qchatInit = function( options ) {
        var settings = $.extend({
          color: '#2c9cff',
          myId: null,
          logo: 'https://cdn-icons-png.flaticon.com/512/134/134914.png',
        }, options );

        if(settings.myId == null) {
          throw 'Your id cannot be null';
        }

        let elem = `#${this[0].id}`;

        QChat.getListChat(settings, elem);

        this.append(`
          <div id="qchat-element">
            <div class="chat-bubble">
              <div class="logo">
                <img src="${settings.logo}">
              </div>
            </div>
            <div class="chat-close">
              <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </div>
            </div>
            <div class="chat-box">
              <div class="chat-header">
                <div class="chat-back">
                  <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                </div>
                <div style="display:flex; justify-content: space-between; width:100%">
                  <div class="chat-title">
                    QChat
                  </div>
                  <div class="chat-exit" style="cursor: pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                  </div>
                </div>
              </div>
              <div class="chat-list-person">
                <div class="content">
                  <div class="list-data">
                    <div class="dp-picture">
                      <img src="https://www.sunsetlearning.com/wp-content/uploads/2019/09/User-Icon-Grey-300x300.png">
                    </div>
                    <div class="dp-message">
                      <h4>Qolbu</h4>
                      <div class="dp-status">
                        <div class="status-icon">
                          <div class="sent">
                            <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#bdbdbd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>
                          </div>
                          <div class="read">
                            <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="${settings.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <svg style="margin-left: -13px;" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="${settings.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>
                          </div>
                        </div>
                        <div class="truncate">
                          <h5>Message</h5>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="msg-status">
                    <h6>13:00</h6>
                    <div class="unread" style="background-color:${settings.color}">1</div>
                  </div>
                </div>
              </div>
              <div class="chat-content" style="display: none">
                <div class="chat-content-list">
                </div>
                <div class="chat-control">
                  <input type="text" id="chat-input" placeholder="Ketik pesan">
                  <button id="btn-send" style="background-color:${settings.color}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `);

        $(`${elem} .chat-list-person`).slimScroll({height: 'calc(100% - 50px)'});

        $(`${elem} .chat-bubble`).click(function() {
          $(this).hide();
          $(`${elem} .chat-close`).css('display', 'flex');
          $(`${elem} .chat-box`).css({'opacity': 1, 'visibility': 'visible'});
        });

        $(`${elem} #btn-send`).prop('disabled', true)

        $(`${elem} #btn-send`).click(function() {
          let text = $(`${elem} #chat-input`).val()
          let groupId = $(this).attr('groupId')
          $(`${elem} #chat-input`).val('')
          $(this).prop('disabled', true)
          QChat.sendChat(settings.myId, groupId, text)
        })

        $(`${elem} #chat-input`).on('keyup', function(e) {
          let regex = /\S/
          let text = $(this).val();
          let groupId = $(this).attr('groupId')

          if(regex.test(text)) {
            $(`${elem} #btn-send`).prop('disabled', false);
            if(e.keyCode == 13) {
              $(`${elem} #chat-input`).val('')
              $(`${elem} #btn-send`).prop('disabled', true)
              QChat.sendChat(settings.myId, groupId, text)
            }
          } else {
            $(`${elem} #btn-send`).prop('disabled', true);
            if(e.keyCode == 13) {
              return false;
            }
          }
        })

        $(`${elem} .chat-close,${elem} .chat-exit`).click(function() {
          $(`${elem} .chat-close`).hide();
          $(`${elem} .chat-bubble`).css('display', 'flex');
          $(`${elem} .chat-box`).css({'opacity': 0, 'visibility': 'hidden'});
        })

        $(`${elem} .chat-back`).click(function() {
          $(this).hide();
          $(`${elem} .chat-title`).text('QChat')
          $(`${elem} .chat-content`).hide();
          $(`${elem} .chat-list-person`).slimScroll({height: 'calc(100% - 50px)'});
        })
    };
}(jQuery));