/*! Copyright (c) 2021 Qolbu Dzikru Rosyadi (http://qolbudr.github.io)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 *
 * Version: 1.0.0
 *
 */
class QChat{static startChat({myId:t,toId:e,myName:n,toName:s,message:i}){let o=t.toString(),a=e.toString();db.collection("user").doc(o).set({id:t,name:n,created:+new Date},{merge:!0}),db.collection("user").doc(a).set({id:e,name:s,created:+new Date},{merge:!0}),db.collection("group").add({created:+new Date,createdBy:t,members:[t,e],recentMessage:{text:i,read:!1,sent:+new Date,sender:t}},{merge:!0}).then(function(e){db.collection(`message/${e.id}/messages`).doc().set({sent:+new Date,sender:t,message:i,read:!1})})}static getMemberData(t,e,n){let s=this;e.forEach(function(e){e!=t&&(s=e)});let i=s.toString();db.collection("user").doc(i).get().then(function(t){let e=t.data();$(`.content[groupId=${n}] h4`).text(e.name)})}static getUnreadCount(t,e){db.collection(`message/${e}/messages`).where("read","==",!1).onSnapshot(function(n){let s=[];n.forEach(function(e){const n=e.data();n.sender!=t&&(n.id=e.id,s.push(n))}),s.length>0?($(`.content[groupId=${e}] .unread`).show(),$(`.content[groupId=${e}] .unread`).text(s.length)):$(`.content[groupId=${e}] .unread`).hide()})}static getChat(t,e,n,s){db.collection(`message/${e}/messages`).orderBy("sent","asc").onSnapshot(function(e){$(`${n} .chat-content-list`).html(""),e.forEach(function(e){let i=e.data();if(i.sender!=t){let t=new Date(i.sent),e=`${t.getHours()}:${("0"+t.getMinutes()).slice(-2)}`;$(`${n} .chat-content-list`).append(`\n              <div class="chat-reply">\n                <div class="text">\n                  <div class="text-data">${i.message}</div>\n                  <div class="text-time">${e}</div>\n                </div>\n              </div>\n            `)}else{let t=new Date(i.sent),e=`${t.getHours()}:${("0"+t.getMinutes()).slice(-2)}`;$(`${n} .chat-content-list`).append(`\n              <div class="chat-send">\n                <div class="text" style="background-color: ${s}">\n                  <div class="text-data">${i.message}</div>\n                  <div class="text-time">${e}</div>\n                </div>\n              </div>\n            `)}});$(`${n} .chat-content-list`).height();$(`${n} .chat-content-list`).slimScroll({scrollTo:1e4})})}static markAsRead(t,e){let n=db.doc(`group/${e}`),s=db.collection(`message/${e}/messages`);n.get().then(function(e){e.data().recentMessage.sender!=t&&n.set({recentMessage:{read:!0}},{merge:!0})}),s.where("read","==",!1).get().then(function(e){e.forEach(function(e){e.data().sender!=t&&s.doc(e.id).set({read:!0},{merge:!0})})})}static sendChat(t,e,n){const s={read:!1,sent:+new Date,text:n,sender:t},i={read:!1,sent:+new Date,message:n,sender:t};db.doc(`group/${e}`).set({recentMessage:s},{merge:!0}),db.collection(`message/${e}/messages`).add(i)}static getListChat(t,e){const n=this;return new Promise((s,i)=>{db.collection("group").where("members","array-contains",t.myId).onSnapshot(s=>{const i=[];s.forEach(t=>{const e=t.data();e.id=t.id,e.recentMessage&&i.push(e)}),n.groups=i,$(`${e} .chat-list-person`).html(""),i.forEach(function(n){let s=new Date(n.recentMessage.sent),i=`${s.getHours()}:${("0"+s.getMinutes()).slice(-2)}`;$(`${e} .chat-list-person`).append(`\n            <div class="content" groupId="${n.id}">\n              <div class="list-data">\n                <div class="dp-picture">\n                  <img src="https://www.sunsetlearning.com/wp-content/uploads/2019/09/User-Icon-Grey-300x300.png">\n                </div>\n                <div class="dp-message">\n                  <h4>Qolbu</h4>\n                  <div class="dp-status">\n                    <div class="status-icon">\n                      <div class="sent">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#bdbdbd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>\n                      </div>\n                      <div class="read">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="${t.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>\n                        <svg style="margin-left: -13px;" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="${t.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>\n                      </div>\n                    </div>\n                    <div class="truncate">\n                      <h5>${n.recentMessage.text}</h5>\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <div class="msg-status">\n                <h6>${i}</h6>\n                <div class="unread" style="background-color: ${t.color}">1</div>\n              </div>\n            </div>\n          `),n.recentMessage.sender!=t.myId?$(`${e} .content[groupId=${n.id}] .status-icon`).hide():($(`${e} .content[groupId=${n.id}] .status-icon`).show(),1==n.recentMessage.read?($(`${e} .content[groupId=${n.id}] .read`).css("display","flex"),$(`${e} .content[groupId=${n.id}] .sent`).hide()):($(`${e} .content[groupId=${n.id}] .sent`).show(),$(`${e} .content[groupId=${n.id}] .read`).hide())),QChat.getMemberData(t.myId,n.members,n.id),QChat.getUnreadCount(t.myId,n.id),$(`${e} .chat-list-person .content`).click(function(){let n=$(`${e} .chat-box`).height()-117,s=$(this).find("h4:first").text(),i=$(this).attr("groupId");$(`${e} .chat-list-person`).slimScroll({height:"0"}),$(`${e} .chat-content-list`).slimScroll({height:n}),$(`${e} .chat-content-list`).css({height:n-29}),$(`${e} .chat-content`).show(),$(`${e} .chat-back`).show(),$(`${e} #chat-input`).attr("groupId",i),$(`${e} #btn-send`).attr("groupId",i),$(`${e} .chat-title`).text(s),window.onresize=function(){n=$(`${e} .chat-box`).height()-117,$(`${e} .chat-content-list`).slimScroll({height:n})},QChat.getChat(t.myId,i,e,t.color),QChat.markAsRead(t.myId,i)})})})})}static openChat({toId:t,myName:e,toName:n,settings:s}){db.collection("group").where("members","==",[s.myId,t]).get().then(function(i){if(i.docs.length){let t=i.docs[0].id,e=s.elem,o=$(`${e} .chat-box`).height()-117;$(`${e} .chat-bubble`).click(),$(`${e} .chat-list-person`).slimScroll({height:"0"}),$(`${e} .chat-content-list`).slimScroll({height:o}),$(`${e} .chat-content-list`).css({height:o}),$(`${e} .chat-content`).show(),$(`${e} .chat-back`).show(),$(`${e} #chat-input`).attr("groupId",t),$(`${e} #btn-send`).attr("groupId",t),$(`${e} .chat-title`).text(n),QChat.getChat(s.myId,t,e,s.color),QChat.markAsRead(s.myId,t)}else db.collection("group").where("members","==",[t,s.myId]).get().then(function(i){if(i.docs.length){let t=i.docs[0].id,e=s.elem,o=$(`${e} .chat-box`).height()-117;$(`${e} .chat-bubble`).click(),$(`${e} .chat-list-person`).slimScroll({height:"0"}),$(`${e} .chat-content-list`).slimScroll({height:o}),$(`${e} .chat-content-list`).css({height:o}),$(`${e} .chat-content`).show(),$(`${e} .chat-back`).show(),$(`${e} #chat-input`).attr("groupId",t),$(`${e} #btn-send`).attr("groupId",t),$(`${e} .chat-title`).text(n),QChat.getChat(s.myId,t,e,s.color),QChat.markAsRead(s.myId,t)}else QChat.startChat({myName:e,toName:n,myId:s.myId,toId:t,message:"Halo"}),QChat.openChat({toId:t,myName:e,toName:n,settings:s})})})}}!function(t){t.fn.qchatInit=function(e){var n=t.extend({color:"#2c9cff",myId:null,logo:"https://cdn-icons-png.flaticon.com/512/134/134914.png"},e);if(null==n.myId)throw"Your id cannot be null";let s=`#${this[0].id}`;return QChat.getListChat(n,s),this.append(`\n          <div id="qchat-element">\n            <div class="chat-bubble">\n              <div class="logo">\n                <img src="${n.logo}">\n              </div>\n            </div>\n            <div class="chat-close">\n              <div class="logo">\n                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>\n              </div>\n            </div>\n            <div class="chat-box">\n              <div class="chat-header">\n                <div class="chat-back">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>\n                </div>\n                <div style="display:flex; justify-content: space-between; width:100%">\n                  <div class="chat-title">\n                    QChat\n                  </div>\n                  <div class="chat-exit" style="cursor: pointer">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>\n                  </div>\n                </div>\n              </div>\n              <div class="chat-list-person">\n                <div class="content">\n                  <div class="list-data">\n                    <div class="dp-picture">\n                      <img src="https://www.sunsetlearning.com/wp-content/uploads/2019/09/User-Icon-Grey-300x300.png">\n                    </div>\n                    <div class="dp-message">\n                      <h4>Qolbu</h4>\n                      <div class="dp-status">\n                        <div class="status-icon">\n                          <div class="sent">\n                            <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#bdbdbd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>\n                          </div>\n                          <div class="read">\n                            <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="${n.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>\n                            <svg style="margin-left: -13px;" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="${n.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>\n                          </div>\n                        </div>\n                        <div class="truncate">\n                          <h5>Message</h5>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  <div class="msg-status">\n                    <h6>13:00</h6>\n                    <div class="unread" style="background-color:${n.color}">1</div>\n                  </div>\n                </div>\n              </div>\n              <div class="chat-content" style="display: none">\n                <div class="chat-content-list">\n                </div>\n                <div class="chat-control">\n                  <input type="text" id="chat-input" placeholder="Ketik pesan">\n                  <button id="btn-send" style="background-color:${n.color}">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        `),t(`${s} .chat-list-person`).slimScroll({height:"calc(100% - 50px)"}),t(`${s} .chat-bubble`).click(function(){t(this).hide(),t(`${s} .chat-close`).css("display","flex"),t(`${s} .chat-box`).css({opacity:1,visibility:"visible"})}),t(`${s} #btn-send`).prop("disabled",!0),t(`${s} #btn-send`).click(function(){let e=t(`${s} #chat-input`).val(),i=t(this).attr("groupId");t(`${s} #chat-input`).val(""),t(this).prop("disabled",!0),QChat.sendChat(n.myId,i,e)}),t(`${s} #chat-input`).on("keyup",function(e){let i=t(this).val(),o=t(this).attr("groupId");if(/\S/.test(i))t(`${s} #btn-send`).prop("disabled",!1),13==e.keyCode&&(t(`${s} #chat-input`).val(""),t(`${s} #btn-send`).prop("disabled",!0),QChat.sendChat(n.myId,o,i));else if(t(`${s} #btn-send`).prop("disabled",!0),13==e.keyCode)return!1}),t(`${s} .chat-close,${s} .chat-exit`).click(function(){t(`${s} .chat-close`).hide(),t(`${s} .chat-bubble`).css("display","flex"),t(`${s} .chat-box`).css({opacity:0,visibility:"hidden"})}),t(`${s} .chat-back`).click(function(){t(this).hide(),t(`${s} .chat-title`).text("QChat"),t(`${s} .chat-content`).hide(),t(`${s} .chat-list-person`).slimScroll({height:"calc(100% - 50px)"})}),n.elem=s,n}}(jQuery);